{% extends 'base.html' %}
{% block content %}

<div class="container-fluid page-container" id="goals-container">
    <!--Fab Menu-->
    <div class="fixed-action-btn hide-on-small-only" id="cards-fab">
        <a class="btn-floating horizontal btn-large red" id="cards-fab-main-btn">
        <i class="large material-icons">dashboard</i>
        </a>
        <ul id="goal-fab-ul">
        {% if (goals | length) < 4%}
        <li>
            <a class="btn-floating darken-1 goal-fab-card" href="{{ url_for('dashboard', username=user.username, add_goal='add') }}"><i class="material-icons">add</i></a>
        </li>
        {% endif %} {% for goal in goals %}
        <li>
            <a class="btn-floating darken-1 goal-fab-card" href="{{url_for('goal_view', username=user.username, goal_id=goal._id)}}" style="background-image: url({{ goal.image_url }})"></a>
        </li>
        {% endfor %}
        </ul>
    </div>
    <div class="row" style="">
        <div class="col s12 m8 offset-m2 l6">
        

             <!--Deposit Card-->
            <div class="card display-none">
                <div class="card-content center">
                  <h4 class="indigo-text">Deposit</h4>
                    <h6 class="light-blue-text uppercase">Current Total: {{ user.currency }}{{ "{:,.2f}".format(goal.current_total) }} </h6>
                    <form action="{{url_for('update_savings', goal_id=goal._id, action='deposit')}}" method="POST">
                        <p class="prefix light-blue-text"> {{ user.currency }} </p>
                        <input value="0.00" min="0.00" max="{{ '{:,.2f}'.format(goal.end_total)}}" id="deposit_value" name="deposit_value" type="number" step="0.01">
                        <a id="deposit-5" class="waves-effect waves-light btn-small blue lighten-2">{{ user.currency }}5</a>
                        <a id="deposit-10" class="waves-effect waves-light btn-small blue lighten-1">{{ user.currency }}10</a>
                        <a id="deposit-25" class="waves-effect waves-light btn-small blue">{{ user.currency }}25</a>
                        <a id="deposit-50" class="waves-effect waves-light btn-small blue darken-1">{{ user.currency }}50</a>
                        <button class="btn waves-effect waves-light blue darken-2" type="submit" name="action">Deposit</button>
                    </form>
                </div>
            </div>  
            <!--Withdraw Card-->
            <div class="card display-none">
                <div class="card-content center">
                 <h4 class="deep-orange-text text-accent-4">Withdraw</h4>
            <h6 class="deep-orange-text text-accent-2 uppercase">Up to {{ user.currency }}{{ "{:,.2f}".format(goal.current_total) }} </h6>
                    <form action="{{url_for('update_savings', goal_id=goal._id, action='withdraw')}}" method="POST">
                        <p class="prefix deep-orange-text text-accent-2"> {{ user.currency }} </p>
                        <input value="0.00" min="0.00" max="{{ '{:,.2f}'.format(goal.current_total) }}" id="withdraw_value" name="withdraw_value" type="number" step="0.01">
                        <a id="withdraw-5" class="waves-effect waves-light btn-small deep-orange lighten-2 {% if goal.current_total < 5 %} disabled {% endif %}">{{ user.currency }}5</a>
                        <a id="withdraw-10" class="waves-effect waves-light btn-small deep-orange lighten-1 {% if goal.current_total < 10 %} disabled {% endif %}">{{ user.currency }}10</a>
                        <a id="withdraw-25" class="waves-effect waves-light btn-small deep-orange {% if goal.current_total < 25 %} disabled {% endif %}">{{ user.currency }}25</a>
                        <a id="withdraw-50" class="waves-effect waves-light btn-small deep-orange darken-1 {% if goal.current_total < 50 %} disabled {% endif %}">{{ user.currency }}50</a>
                   
                        <button class="btn waves-effect waves-light deep-orange darken-2" type="submit" name="action">Withdraw</button>
            </form>
                </div>
            </div>
            <!--Edit Goal Card-->
            <div class="card display-none">
                <div class="card-content center">
                  <h4 class="indigo-text center">Edit Goal</h4>
                    <div class="row">
                    <form action="{{url_for('update_goal', goal_id=goal._id)}}" method="POST"class="col s12">
                            <div class="row">
                                <div class="input-field col s12 m6 offset-m3">
                                    <input id="goal_name" name="goal_name" type="text" value="{{goal.goal_name}}" required>
                                    <label for="goal_name" class="indigo-text">Goal Name</label>
                                </div>
                                <div class="input-field col s12 m6 offset-m3">
                                    <input id="image_url" name="image_url" type="text" value="{{goal.image_url}}" required>
                                    <label for="image_url" class="indigo-text">Goal Image URL</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s12 m6 offset-m3">
                                    <input id="end_total" name="end_total" type="text" value="{{'{:,.2f}'.format(goal.end_total) }}" required>
                                    <label for="end_total" class="indigo-text">Goal Total ({{user.currency}}):</label>
                                </div>
                            </div>
                            <div class="row">
                                    <div class="input-field col s12 m6 offset-m3">
                                        <input id="end_date" name="end_date" type="text" class="datepicker" value='{{ goal.end_date.strftime("%b %d, %Y") }}' required>
                                        <label for="icon_prefix" class="indigo-text">Goal End Date</label>
                                    </div>
                            </div>
                            <div class="col s12 center">
                            <button class="btn waves-effect waves-light modal-close teal lighten-2">Cancel</button>
                            <button class="btn waves-effect waves-light indigo" type="submit" id="edit-goal-submit-btn" name="action">Edit Goal</button>
                        </div>
                    </div>
                </div> 
            </div>
            <!--Delete Goal Card-->
            <div class="card display-none">
                <div class="card-content center">
                  <h4 class="indigo-text center">Delete Goal</h4>
                    <div class="row">
                        <h6 class="light-blue-text uppercase">{{ goal.goal_name }} </h6>
                        <p>Are you sure you want to delete your goal forever?</p>
                        <button class="btn waves-effect waves-light modal-close teal lighten-2">Cancel</button>
                        <a href="{{url_for('delete_goal', goal_id=goal._id)}}" class="modal-action modal-close waves-effect waves-red btn red lighten-1">Delete</a>   
                    </div>
                </div> 
            </div>
            {% if goal.achieved %}
            <!--achieved goal card-->
            <div class="card" id="achieved-goal-card">
                <div class="card-content center">
                <h3 class="gold-lowpoly"><strong>Congratulations!</strong></h3>
                <h5 class="gold-lowpoly">You've reached your goal and saved {{user.currency}}{{"{:,.2f}".format(goal.end_total)}}</h5>
                </div> 
            </div>
            {% endif %}
            <!--Main Card-->
             <div class="card" id="title-card">
                <div class="card-content center">
                    <h5 class="uppercase spaced-text center dark-blue-lowpoly"><strong>{{goal.goal_name}}</strong></h5>
                    <h5 class="uppercase spaced-text center dark-blue-lowpoly">{{user.currency}}{{"{:,.2f}".format(goal.end_total)}} goal</h5>
                </div>
             </div>
            <div class="card" id="goal-main-card">
                <div class="card-content center">
                    <img src="{{goal.image_url}}" class="goal-image">
                   
                    <div class="progress">
                        <div class="determinate" style="width: {{ goal.percent_progress }}%"></div>
                    </div>
                    <div id="progress-labels">
                        <h6 class="left repeatable-lowpoly-text"><strong>{{user.currency}}{{"{:,.2f}".format(goal.current_total)}} saved</strong> </h6>
                        <h6 class="right repeatable-lowpoly-text"><strong>{{user.currency}}{{"{:,.2f}".format(goal.end_total - goal.current_total)}} left</strong></h6>   
                    </div>
                </div> 
            </div>
             <!--Savings Forecast-->
            <div class="card">
                <div class="card-content">
                    <h5 class="uppercase spaced-text center geo-card-3" id="savings-forecast-header"><strong>Savings Forecast</strong></h5>     
                    <div class="row">
                        <div class="col s6">
                            <span id="user-savings-figure"><strong>{{ user.currency}}{{ "{:,.2f}".format((avg_saved_perday * 7))}}</strong></span>  
                            <br>
                            <span class="grey-text uppercase"><strong>Average weekly savings </strong></span>
                            <span class="grey-text"></br>{{ user.currency }}{{ "{:,.2f}".format(avg_saved_perday) }}/day</span>
                        </div>
                        <div class="col s6" id="needed-savings-col">
                            <span id="needed-savings-figure"><strong>{{ user.currency }}{{ "{:,.2f}".format((avg_needed_perday * 7))}}</strong></span>
                            <br />
                            <span class="grey-text uppercase"><strong>Needed weekly savings </strong></span>
                            <span class="grey-text"></br>{{ user.currency}}{{ "{:,.2f}".format(avg_needed_perday) }}/day</span>
                        </div>
                    </div>
                    {% if forecast_remaining_days != "unforcastable" %}
                    {% if (forecast_remaining_days| round(0, 'ceil') | int) < ((goal.end_date.date() - date_today).days)  %}
                    <div class="center">
                        <div class="green-highlight-gradient forecast-highlight">
                            <strong>{{ forecast_remaining_days| round(0, 'ceil') | int }}</strong> days until you meet your goal <br>
                            <strong>{{ (goal.end_date.date() - date_today).days - (forecast_remaining_days| round(0, 'ceil') | int) }}</strong> days before your chosen date 
                        </div>
                        <div class="card-action">
                            <span class="grey-text uppercase">Want to increase your goal?</span>
                            <a href="" class="center uppercase savings-card-link"><strong>Edit Goal</strong></a>
                        </div>
                    </div>
                    {% elif (forecast_remaining_days| round(0, 'ceil') | int) == ((goal.end_date.date() - date_today).days) %}
                    <div class="center">
                        <div class="green-highlight-gradient forecast-highlight">
                            <span>You're on track to reach your goal in <strong>{{ forecast_remaining_days| round(0, 'ceil') | int }}</strong> days.</span>
                            <br>
                            <strong>That's right on time!</strong>
                        </div>
                    </div>
                    {% else %}
                    <div class="center">
                        <div class="red-highlight-gradient forecast-highlight">
                            <strong>{{ forecast_remaining_days| round(0, 'ceil') | int }}</strong> days until you meet your goal <br> <strong>{{ (forecast_remaining_days| round(0, 'ceil') | int) - (goal.end_date.date() - date_today).days }}</strong> days past your chosen date
                        </div>
                        <div class="card-action">
                            <span class="grey-text uppercase">Need to extend your end date?</span>
                            <a href="#edit-goal-modal" class="modal-trigger center uppercase savings-card-link"><strong>Edit Goal</strong></a></span>
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
            <!--Recent Activity Card-->
            {% if goal.savings_history %}
            <div class="card">
                <div class="card-content center blue-text">
                    <h5 class="center uppercase spaced-text"><strong>Recent Activity</strong></h5>
                    <span><a href="{{ url_for('savingshistory', username=user.username, goal_id=goal._id) }}"" class="center lowpoly-link"><strong>View Full Savings History</strong></a></span>
                    <!--Savings History Table-->
                    <div class="blue-lowpoly-border">
                        <table class="highlight">
                        <thead>
                        <tr>
                            <th class="uppercase spaced-text">Amount</th>
                            <th class="uppercase right spaced-text">Date</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for item in goal.savings_history | sort(reverse=true) %} <!--reverse item order as can only push to mongodb array -->
                        {% if loop.index <= 5 %}
                        <tr>
                            {% if item[1] > 0 %}
                            <td class="table-deposit green-lowpoly">
                                <h6><i class="material-icons tiny">arrow_upward</i><strong class="deposits-main-figure">{{user.currency}}{{ "{:,.2f}".format(item[1]) }}</strong></h6>
                            </td>
                            {% else %}
                            <td class="table-withdrawal red-lowpoly">
                               <h6><i class="material-icons tiny">arrow_downward</i><strong class="withdrawals-main-figure">{{user.currency}}{{ "{:,.2f}".format(0 - item[1]) }}</strong><h6>
                            </td>
                            {% endif %}
                            <td class="right dark-blue-lowpoly"><strong>{{ item[0].strftime("%d %b, %Y") }}</strong></td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        </tbody>
                        </table>
                    </div>
                </div> 
            </div>
            {% endif %}
        </div>
        <div class="col s12 m8 offset-m2 l4">
            <!--Progress Doughnut Card-->
            <div class="card">
                <div class="card-content center blue-text">
                     <!--Progress Dougnut Chart-->
                           <div class="chart-wrapper">
                                <canvas id="goal-progress-pie"></canvas>      
                                <div class="chart-text">
                                    <h4 class="dark-blue-lowpoly">{{ goal.percent_progress }}%</h4>
                                    <span class="dark-blue-lowpoly uppercase spaced-text">saved</span>
                                </div>
                            </div>
                            <h4 class="center uppercase dark-blue-lowpoly" style="letter-spacing: 10px; margin-top: 50px;">Progress</h4>
                  
                            <div class="gold-lowpoly spaced-text">
                            <strong>
                            {% if goal.percent_progress < 25 %}
                            {% elif goal.percent_progress < 33 %}
                            You're close to saving a third of your total!
                            {% elif goal.percent_progress < 50 %}
                            You're nearly half way there!
                            {% elif goal.percent_progress < 60 %}
                            You're over half way to achieving your goal!
                            {% elif goal.percent_progress > 75 %}
                            You're in the final quarter!
                            {% elif goal.percent_progres == 100 %}
                            Congratulations! You've reached your goal!
                            {% else %}
                            Congratulations! You've exceeded your goal! 
                            {% endif %}
                            </strong>
                            </div>
                </div>
            </div>
            <div class="row">
                <div class="col s6">
            <div class="card">
                <div class="card-content center">
                             <button class="btn waves-effect waves-light form-red-btn" type="button" id="create-goal-cancel">Withdraw</button>
                </div>
            </div>
        </div>
        <div class="col s6">
            <div class="card">
                <div class="card-content center">
                <button class="btn waves-effect waves-dark update-btn" id="create-goal-submit" type="submit" name="action">Deposit</button>
                </div>
            </div>
        </div>
            </div>
            <!--Time Remaining-->
            <div class="card">
                <div class="card-content" id="time-stats-card">
                    <i class="material-icons" id="time-stats-icon">date_range</i>
                    <h5 class="center uppercase" id="time-stats-one">Day <strong class="indigo-text text-darken-1">{{ (date_today - goal.start_date.date()).days }}</strong> of <strong class="indigo-text text-darken-2">{{ (goal.end_date.date() - goal.start_date.date()).days }}</strong> </h5>
                    <h5 class="center uppercase display-none" id="time-stats-two"><strong class="indigo-text text-darken-1">{{ (goal.end_date.date() - date_today).days }}</strong> days left</strong></h5>
                    <p class="center"><strong>{{goal.start_date.strftime("%d %b, %Y")}} - {{goal.end_date.strftime("%d %b, %Y") }}</strong></p>
                </div>
            </div>
             <!--Deposit/Withdrawal Gauge-->
            <div class="card">
                <div class="card-content">
                    <canvas id="goal-deposits-gauge"></canvas>    
                    <div class="center">
                        <div class="row">
                            <div class="col s6"> 
                                <h4><i class="material-icons deposits-arrow">arrow_upward</i><strong class="deposits-main-figure">{{ goal.deposits_number }}</strong></h4>
                                <h6 class="uppercase" id="deposits-label"> Deposit{% if goal.deposits_number != 1 %}s{% endif %}</h6>
                            </div>
                            <div class="col s6">
                                <h4><i class="material-icons withdrawals-arrow">arrow_downward</i><strong class="withdrawals-main-figure">{{ goal.withdrawals_number }}</strong></h4>
                                <h6 class="uppercase" id="withdrawals-label">Withdrawal{% if goal.withdrawals_number != 1 %}s{% endif %}</h6>
                            </div>
                        {% if not goal.savings_history %}
                        <div class="grey valign-wrapper view goal-card-overlay">
                            <div>
                                <h5 class="center-align">Make your first deposit to activate savings insights</h5>
                                <a href="#update-savings-modal" class="modal-trigger btn light-blue darken-2">Deposit</a>
                            </div>
                        </div>
                        {% endif %}
                        </div>
                    </div>
                </div>
            </div>
             <!--Deposit/Withdrawal Stats-->
            <div class="card">
                <div class="card-content">
                <div class="row">
                <div class="col s6">
                    {% if goal.deposits_number == 0 %}
                    <h5 id="smallest-deposit"><strong>{{user.currency }}--</strong></h5>
                    {% else %}
                    <h5 id="smallest-deposit"><strong>{{user.currency }}{{ "{:,.2f}".format((all_deposits | min)) }}</strong></h5>
                    {% endif %}
                    <h6 class="insight-description"> Smallest Deposit</h6>
                    {% if goal.deposits_number == 0 %}
                    <h5 id="biggest-deposit"> <strong>{{user.currency }}--</strong></h5>
                    {% else %}
                    <h5 id="biggest-deposit"> <strong>{{user.currency }}{{ "{:,.2f}".format((all_deposits | max)) }}</strong></h5>
                    {% endif %}
                    <h6 class="insight-description"> Biggest Deposit</h6>
                    {% if goal.deposits_number == 0 %}
                    <h5 id="avg-deposit"> <strong>{{user.currency }}--</strong></h5>
                    {% else %}
                    <h5 id="avg-deposit"> <strong>{{user.currency }}{{ "{:,.2f}".format(avg_deposit) }}</strong></h5>
                    {% endif %}
                    <h6 class="insight-description"> Average Deposit</h6>  
                </div>
                <div class="col s6" style="text-align: right">
                    {% if goal.withdrawals_number == 0 %}
                    <h5 id="smallest-withdrawal"> <strong>{{user.currency }}--</strong></h5>
                    {% else %}
                    <h5 id="smallest-withdrawal"> <strong>{{user.currency }}{{ "{:,.2f}".format((all_withdrawals | min)) }}</strong></h5>
                    {% endif %}
                    <h6 class="insight-description"> Smallest Withdrawal</h6>
                    {% if goal.withdrawals_number == 0 %}
                    <h5 id="biggest-withdrawal"> <strong>{{user.currency }}--</strong></h5>
                    {% else %}
                    <h5 id="biggest-withdrawal"> <strong>{{user.currency}}{{ "{:,.2f}".format((all_withdrawals | max)) }}</strong></h5>
                    {% endif %}
                    <h6 class="insight-description"> Biggest Withdrawal</h6>
                    {% if goal.withdrawals_number == 0 %}
                    <h5 id="avg-withdrawal"> <strong>{{user.currency }}--</strong></h5>
                    {% else %}
                    <h5 id="avg-withdrawal"> <strong>{{user.currency }}{{ "{:,.2f}".format(avg_withdrawal) }}</strong></h5>
                    {% endif %}
                    <h6 class="insight-description"> Average Withdrawal</h6>
                </div>
            </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block include_js_html %}
<!--load chart.js-->
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script>
depositsGauge('goal-deposits-gauge', {{ goal.deposits_number }}, {{ goal.withdrawals_number }})
function depositsGauge (elemId, deposits, withdrawals){
  var ctx = document.getElementById(elemId).getContext('2d');
  // create the gradient for the line/area part of chart
    var gradientDeposit = ctx.createLinearGradient(500, 0, 0, 0);
    gradientDeposit.addColorStop(0, 'rgba(0, 167, 155, 0.7')
    gradientDeposit.addColorStop(0.2, 'rgba(41, 222, 165, 0.7')
    gradientDeposit.addColorStop(1, 'rgba(17, 207, 195, 0.7')
    var gradientDepositBorder = ctx.createLinearGradient(500, 0, 0, 0);
    gradientDepositBorder.addColorStop(0, 'rgba(0, 167, 155, 1')
    gradientDepositBorder.addColorStop(0.2, 'rgba(41, 222, 165, 0.7')
    gradientDepositBorder.addColorStop(1, 'rgba(17, 207, 195, 0.7')
    var gradientWithdrawal = ctx.createLinearGradient(500, 0,0, 0);
    gradientWithdrawal.addColorStop(0.2, 'rgba(238, 9, 121, 0.7') 
    gradientWithdrawal.addColorStop(0, 'rgba(244, 107, 69, 0.7')
    gradientWithdrawal.addColorStop(1, 'rgba(229, 57, 35, 0.7')
    var gradientWithdrawalBorder = ctx.createLinearGradient(500, 0, 0, 0);
    gradientWithdrawalBorder.addColorStop(0.1, 'rgba(238, 9, 121, 0.9') 
    gradientWithdrawalBorder.addColorStop(0, 'rgba(244, 107, 69, 0.9')
    gradientWithdrawalBorder.addColorStop(1, 'rgba(229, 57, 35, 0.9') 
  var myChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['Deposits', 'Withdrawals'],
        datasets: [{
            label: 'Deposits/Withdrawals',
            data: [deposits, withdrawals],
            backgroundColor: [
                gradientDeposit,
                gradientWithdrawal
            ],
            borderColor: [
                gradientDepositBorder,
                gradientWithdrawalBorder
            ],
            borderWidth: 1
        }]
    },
    options: {
        legend: {
            position: 'bottom'
        },
      // these options make it a gauge chart/half doughnut
          rotation: 1 * Math.PI,
    circumference: 1 * Math.PI
    }
});
}
$(document).ready(function(){
    
})
$("#time-stats-card").hover(function() {
    $("#time-stats-one, #time-stats-two").toggleClass("display-none");
});


 $("#withdraw-5").click(function(){
            $("#withdraw_value").val("5.00")
        });
        $("#withdraw-10").click(function(){
            $("#withdraw_value").val("10.00")
        });
        $("#withdraw-25").click(function(){
            $("#withdraw_value").val("25.00")
        });
        $("#withdraw-50").click(function(){
            $("#withdraw_value").val("50.00")
        });
        $("#deposit-5").click(function(){
            $("#deposit_value").val("5.00")
        });
        $("#deposit-10").click(function(){
            $("#deposit_value").val("10.00")
        });
        $("#deposit-25").click(function(){
            $("#deposit_value").val("25.00")
        });
        $("#deposit-50").click(function(){
            $("#deposit_value").val("50.00")
        });


         $('#edit-goal-submit-btn').click(function(e) {
        e.preventDefault();
        given_url = $('#image_url').val()
        given_url_extension = given_url.split('.').pop();
        if (given_url_extension == "jpeg" || given_url_extension == "png" || given_url_extension == "jpg"){
            $("#add-goal-form").submit();
        }
        else {
            alert("That doesn't look like an image URL")
            }
    })

$('.datepicker').datepicker({
            // set default date to goal end date
            setDefaultDate: '{{ goal.end_date.strftime("%b %d, %Y") }}',
            // prevent selecting end date before todays date
            minDate: new Date({{ date_today.strftime('%Y,%m,%d') }}),
            // only allow years to be current/future years
            yearRange: [2020, 2100]
        });
    //open datepicker on focusing on date field 
 $("#end_date").focus(function(){
    $('#end_date').click();
 })
</script>
{% include 'viewgoal_js.html' %}
{% endblock %}