{% extends 'base.html' %} {% block nav_links %}
<li><a href="{{ url_for('index') }}">Home</a></li>
<li><a href="{{ url_for('dashboard', username=user.username) }}">Dashboard</a></li>
{% if user.goals_number != 0 %}
<li><a class="dropdown-trigger" href="#!" data-target="nav_goals">Goals<i class="material-icons right">arrow_drop_down</i></a></li>
<ul id="nav_goals" class="dropdown-content">
    {% for goal in goals %}
    <li><a href="{{ url_for('goal_view', username=user.username, goal_id=goal._id) }}" class="uppercase">{{goal.goal_name}}</a></li>
    {% endfor %}
    {% if user.goals_number < 4 %}
    <li class="divider"></li>
    <li><a href="{{ url_for('dashboard', username=user.username, add_goal='add') }}" class="modal-trigger uppercase"><i class="material-icons">add_box</i>New</a></li>
    {% endif %} 
</ul>
{% endif %}
<li><a href="{{url_for('profile', username=user.username)}}">Profile</a></li>
<li><a href="{{url_for('logout')}}">Log Out</a></li>
{% endblock %} 
{% block content %}
<div class="container-fluid" id="goals-container">
    <!--Fab Menu-->
    <div class="fixed-action-btn" id="cards-fab">
        <a class="btn-floating horizontal btn-large red" id="cards-fab-main-btn">
        <i class="large material-icons">dashboard</i>
        </a>
        <ul id="goal-fab-ul">
        {% if (goals | length) < 4%}
        <li>
            <a class="btn-floating darken-1 goal-fab-card" href="{{ url_for('dashboard', username=user.username, add_goal='add') }}"><i class="material-icons">add</i></a>
        </li>
        {% endif %} {% for goal in goals %}
        <li>
            <a class="btn-floating darken-1 goal-fab-card" style="background-image: url({{ goal.image_url }})"></a>
        </li>
        {% endfor %}
        </ul>
    </div>
    <div class="row" style="">
        <div class="col s12 m8 offset-m2 l6 offset-l3">
            <!--Main Card-->
            <div class="card">
                <div class="card-content center">
                    <div class="blue-lowpoly-border">
                    <img src="{{goal.image_url}}" class="goal-image">
                        <h4 class="center uppercase spaced-text dark-blue-lowpoly"><strong>{{ goal.goal_name }}</strong></h4>
                        <span><a href="#" class="lowpoly-link modal-trigger center"><strong>Edit Goal</strong></a></span>
                    </div>
                    </div> 
            </div>
            <!--Deposit/Withdraw Card-->
            <div class="card">
                <div class="card-content center">
                 {% if not goal.achieved %}
                            <div style="margin-bottom: 10px; margin-top: 10px;">
                                <h6 class="left progress-bar-label"><strong>{{user.currency}}{{"{:,.2f}".format(goal.current_total)}} saved</strong> </h6>
                                <h6 class="right progress-bar-label"><strong>{{user.currency}}{{"{:,.2f}".format(goal.end_total - goal.current_total)}} left</strong></h6>
                                <br>
                                <div class="progress">
                                    <div class="determinate" style="width: {{ goal.percent_progress }}%"></div>
                                </div>
                                <h6 class="center progress-bar-label"><strong>{{user.currency}}{{("{:,.2f}".format(goal.end_total))}} total</strong></h6>
                            </div>
                            {% else %}
                                <p><strong>Congratulations!</strong></p>
                                <p>You've reached your goal and saved {{user.currency}}{{goal.end_total}}</p>
                            {% endif %}
                    <button class="btn waves-effect waves-light form-red-btn" type="button" id="create-goal-cancel">Withdraw</button>
                    <button class="btn waves-effect waves-dark update-btn" id="create-goal-submit" type="submit" name="action">Deposit</button>
                </div> 
            </div>
            <!--Recent Activity Card-->
            {% if goal.savings_history %}
            <div class="card">
                <div class="card-content center blue-text">
                    <h5 class="center uppercase spaced-text"><strong>Recent Activity</strong></h5>
                    <span><a href="{{ url_for('savingshistory', username=user.username, goal_id=goal._id) }}"" class="center lowpoly-link"><strong>View Full Savings History</strong></a></span>
                    <!--Savings History Table-->
                    <div class="blue-lowpoly-border">
                        <table class="highlight">
                        <thead>
                        <tr>
                            <th class="uppercase spaced-text">Amount</th>
                            <th class="uppercase right spaced-text">Date</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for item in goal.savings_history | sort(reverse=true) %} <!--reverse item order as can only push to mongodb array -->
                        {% if loop.index <= 5 %}
                        <tr>
                            {% if item[1] > 0 %}
                            <td class="table-deposit green-lowpoly">
                                <h6><i class="material-icons tiny">arrow_upward</i><strong class="deposits-main-figure">{{user.currency}}{{ "{:,.2f}".format(item[1]) }}</strong></h6>
                            </td>
                            {% else %}
                            <td class="table-withdrawal red-lowpoly">
                               <h6><i class="material-icons tiny">arrow_downward</i><strong class="withdrawals-main-figure">{{user.currency}}{{ "{:,.2f}".format(0 - item[1]) }}</strong><h6>
                            </td>
                            {% endif %}
                            <td class="right dark-blue-lowpoly"><strong>{{ item[0].strftime("%d %b, %Y") }}</strong></td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                        </tbody>
                        </table>
                    </div>
                </div> 
            </div>
            {% endif %}
            <!--Progress Doughnut Card-->
            {% if goal.savings_history %}
            <div class="card">
                <div class="card-content center blue-text">
                     <!--Progress Dougnut Chart-->
                           <div class="chart-wrapper">
                                <canvas id="goal-progress-pie"></canvas>      
                                <div class="chart-text">
                                    <h4 class="dark-blue-lowpoly">{{ goal.percent_progress }}%</h4>
                                    <span class="dark-blue-lowpoly uppercase spaced-text">saved</span>
                                </div>
                            </div>
                            <h4 class="center uppercase dark-blue-lowpoly" style="letter-spacing: 10px; margin-top: 50px;"><strong>Progress</strong></h4>
                  
                            <div class="gold-lowpoly spaced-text">
                            <strong>
                            {% if goal.percent_progress < 25 %}
                            {% elif goal.percent_progress < 33 %}
                            You're close to saving a third of your total!
                            {% elif goal.percent_progress < 50 %}
                            You're nearly half way there!
                            {% elif goal.percent_progress < 60 %}
                            You're over half way to achieving your goal!
                            {% elif goal.percent_progress > 75 %}
                            You're in the final quarter!
                            {% elif goal.percent_progres == 100 %}
                            Congratulations! You've reached your goal!
                            {% else %}
                            Congratulations! You've exceeded your goal! 
                            {% endif %}
                            </strong>
                            </div>
                </div>
            </div>
            {% endif %}
            <!--Deposit/Withdrawal Stats-->
            {% if goal.savings_history %}
            <div class="card">
                <div class="card-content">
                <div class="row">
                                    <div class="col s6">
                                        {% if goal.deposits_number == 0 %}
                                        <h5 id="smallest-deposit"><strong>{{user.currency }}--</strong></h5>
                                        {% else %}
                                        <h5 id="smallest-deposit"><strong>{{user.currency }}{{ "{:,.2f}".format((all_deposits | min)) }}</strong></h5>
                                        {% endif %}
                                        <h6 class="insight-description"> Smallest Deposit</h6>
                                        {% if goal.deposits_number == 0 %}
                                        <h5 id="biggest-deposit"> <strong>{{user.currency }}--</strong></h5>
                                        {% else %}
                                        <h5 id="biggest-deposit"> <strong>{{user.currency }}{{ "{:,.2f}".format((all_deposits | max)) }}</strong></h5>
                                        {% endif %}
                                        <h6 class="insight-description"> Biggest Deposit</h6>
                                        {% if goal.deposits_number == 0 %}
                                        <h5 id="avg-deposit"> <strong>{{user.currency }}--</strong></h5>
                                        {% else %}
                                        <h5 id="avg-deposit"> <strong>{{user.currency }}{{ "{:,.2f}".format(avg_deposit) }}</strong></h5>
                                        {% endif %}
                                        <h6 class="insight-description"> Average Deposit</h6>  
                                    </div>
                                    <div class="col s6" style="text-align: right">
                                        {% if goal.withdrawals_number == 0 %}
                                        <h5 id="smallest-withdrawal"> <strong>{{user.currency }}--</strong></h5>
                                        {% else %}
                                        <h5 id="smallest-withdrawal"> <strong>{{user.currency }}{{ "{:,.2f}".format((all_withdrawals | min)) }}</strong></h5>
                                        {% endif %}
                                        <h6 class="insight-description"> Smallest Withdrawal</h6>
                                        {% if goal.withdrawals_number == 0 %}
                                        <h5 id="biggest-withdrawal"> <strong>{{user.currency }}--</strong></h5>
                                        {% else %}
                                        <h5 id="biggest-withdrawal"> <strong>{{user.currency}}{{ "{:,.2f}".format((all_withdrawals | max)) }}</strong></h5>
                                        {% endif %}
                                        <h6 class="insight-description"> Biggest Withdrawal</h6>
                                        {% if goal.withdrawals_number == 0 %}
                                        <h5 id="avg-withdrawal"> <strong>{{user.currency }}--</strong></h5>
                                        {% else %}
                                        <h5 id="avg-withdrawal"> <strong>{{user.currency }}{{ "{:,.2f}".format(avg_withdrawal) }}</strong></h5>
                                        {% endif %}
                                        <h6 class="insight-description"> Average Withdrawal</h6>
                                    </div>
                                </div>

    
                </div>
            </div>
            {% endif %}
            <!--Deposit/Withdrawal Gauge-->
            {% if goal.savings_history %}
            <div class="card">
                <div class="card-content">
                    <canvas id="goal-deposits-gauge"></canvas>    
                    <div class="center">
                        <div class="row">
                            <div class="col s6"> 
                                <h4><i class="material-icons deposits-arrow">arrow_upward</i><strong class="deposits-main-figure">{{ goal.deposits_number }}</strong></h4>
                                <h6 class="uppercase" id="deposits-label"> Deposit{% if goal.deposits_number != 1 %}s{% endif %}</h6>
                            </div>
                            <div class="col s6">
                                <h4><i class="material-icons withdrawals-arrow">arrow_downward</i><strong class="withdrawals-main-figure">{{ goal.withdrawals_number }}</strong></h4>
                                <h6 class="uppercase" id="withdrawals-label">Withdrawal{% if goal.withdrawals_number != 1 %}s{% endif %}</h6>
                            </div>
                        {% if not goal.savings_history %}
                        <div class="grey valign-wrapper view goal-card-overlay">
                            <div>
                                <h5 class="center-align">Make your first deposit to activate savings insights</h5>
                                <a href="#update-savings-modal" class="modal-trigger btn light-blue darken-2">Deposit</a>
                            </div>
                        </div>
                        {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            <!--Savings Forecast-->
            {% if goal.savings_history %}
            <div class="card">
                <div class="card-content">
                    <h5 class="uppercase spaced-text center geo-card-3" id="savings-forecast-header"><strong>Savings Forecast</strong></h5>     
                        <div class="row">
                            <div class="col s6">
                                <span id="user-savings-figure"><strong>{{ user.currency}}{{ "{:,.2f}".format((avg_saved_perday * 7))}}</strong></span>  
                                <br>
                                <span class="grey-text uppercase"><strong>Average weekly savings </strong></span>
                                <span class="grey-text"></br>{{ user.currency }}{{ "{:,.2f}".format(avg_saved_perday) }}/day</span>
                            </div>
                            <div class="col s6" id="needed-savings-col">
                              <span id="needed-savings-figure"><strong>{{ user.currency }}{{ "{:,.2f}".format((avg_needed_perday * 7))}}</strong></span>
                               <br />
                               <span class="grey-text uppercase"><strong>Needed weekly savings </strong></span>
                                <span class="grey-text"></br>{{ user.currency}}{{ "{:,.2f}".format(avg_needed_perday) }}/day</span>
                            </div>
                        </div>
                        {% if forecast_remaining_days != "unforcastable" %}
                        {% if (forecast_remaining_days| round(0, 'ceil') | int) < ((goal.end_date.date() - date_today).days)  %}
                        <div class="center">
                            <div class="green-highlight-gradient forecast-highlight">
                                <strong>{{ forecast_remaining_days| round(0, 'ceil') | int }}</strong> days until you meet your goal <br>
                                <strong>{{ (goal.end_date.date() - date_today).days - (forecast_remaining_days| round(0, 'ceil') | int) }}</strong> days before your chosen date 
                            </div>
                            <div class="card-action">
                                <span class="grey-text uppercase">Want to increase your goal?</span>
                                <a href="#edit-goal-modal" class="modal-trigger center uppercase savings-card-link"><strong>Edit Goal</strong></a></span>
                            </div>
                        </div>
                        {% elif (forecast_remaining_days| round(0, 'ceil') | int) == ((goal.end_date.date() - date_today).days) %}
                        <div class="center">
                            <div class="green-highlight-gradient forecast-highlight">
                                <span>You're on track to reach your goal in <strong>{{ forecast_remaining_days| round(0, 'ceil') | int }}</strong> days.</span>
                                <br>
                                <strong>That's right on time!</strong>
                            </div>
                        </div>
                        {% else %}
                        <div class="center">
                        <div class="red-highlight-gradient forecast-highlight">
                            <strong>{{ forecast_remaining_days| round(0, 'ceil') | int }}</strong> days until you meet your goal <br> <strong>{{ (forecast_remaining_days| round(0, 'ceil') | int) - (goal.end_date.date() - date_today).days }}</strong> days past your chosen date
                        </div>
                        <div class="card-action">
                            <span class="grey-text uppercase">Need to extend your end date?</span>
                            <a href="#edit-goal-modal" class="modal-trigger center uppercase savings-card-link"><strong>Edit Goal</strong></a></span>
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
             <!--Time Remaining-->
            {% if goal.savings_history %}
            <div class="card">
                <div class="card-content">
                    
                            <i class="material-icons" id="time-stats-icon">date_range</i>
                            <h5 class="center uppercase" id="time-stats-one">Day <strong class="indigo-text text-darken-1">{{ (date_today - goal.start_date.date()).days }}</strong> of <strong class="indigo-text text-darken-2">{{ (goal.end_date.date() - goal.start_date.date()).days }}</strong> </h5>
                            <h5 class="center uppercase display-none" id="time-stats-two"><strong class="indigo-text text-darken-1">{{ (goal.end_date.date() - date_today).days }}</strong> days left</strong></h5>
                            <p class="center"><strong>{{goal.start_date.strftime("%d %b, %Y")}} - {{goal.end_date.strftime("%d %b, %Y") }}</strong></p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
{% block include_js_html %}
<!--load chart.js-->
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script>
depositsGauge('goal-deposits-gauge', {{ goal.deposits_number }}, {{ goal.withdrawals_number }})
function depositsGauge (elemId, deposits, withdrawals){
  var ctx = document.getElementById(elemId).getContext('2d');
  // create the gradient for the line/area part of chart
    var gradientDeposit = ctx.createLinearGradient(500, 0, 0, 0);
    gradientDeposit.addColorStop(0, 'rgba(0, 167, 155, 0.7')
    gradientDeposit.addColorStop(0.2, 'rgba(41, 222, 165, 0.7')
    gradientDeposit.addColorStop(1, 'rgba(17, 207, 195, 0.7')
    var gradientDepositBorder = ctx.createLinearGradient(500, 0, 0, 0);
    gradientDepositBorder.addColorStop(0, 'rgba(0, 167, 155, 1')
    gradientDepositBorder.addColorStop(0.2, 'rgba(41, 222, 165, 0.7')
    gradientDepositBorder.addColorStop(1, 'rgba(17, 207, 195, 0.7')
    var gradientWithdrawal = ctx.createLinearGradient(500, 0,0, 0);
    gradientWithdrawal.addColorStop(0.2, 'rgba(238, 9, 121, 0.7') 
    gradientWithdrawal.addColorStop(0, 'rgba(244, 107, 69, 0.7')
    gradientWithdrawal.addColorStop(1, 'rgba(229, 57, 35, 0.7')
    var gradientWithdrawalBorder = ctx.createLinearGradient(500, 0, 0, 0);
    gradientWithdrawalBorder.addColorStop(0.1, 'rgba(238, 9, 121, 0.9') 
    gradientWithdrawalBorder.addColorStop(0, 'rgba(244, 107, 69, 0.9')
    gradientWithdrawalBorder.addColorStop(1, 'rgba(229, 57, 35, 0.9') 
  var myChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['Deposits', 'Withdrawals'],
        datasets: [{
            label: 'Deposits/Withdrawals',
            data: [deposits, withdrawals],
            backgroundColor: [
                gradientDeposit,
                gradientWithdrawal
            ],
            borderColor: [
                gradientDepositBorder,
                gradientWithdrawalBorder
            ],
            borderWidth: 1
        }]
    },
    options: {
        legend: {
            position: 'bottom'
        },
      // these options make it a gauge chart/half doughnut
          rotation: 1 * Math.PI,
    circumference: 1 * Math.PI
    }
});
}
</script>
{% include 'viewgoal_js.html' %}
{% endblock %}